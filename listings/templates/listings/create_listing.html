{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}

{% block extra_head %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
      crossorigin=""/>
{% endblock %}

{% block content %}
<h2 class="text-center">Post A Parking Spot</h2>

{% if not request.user.profile.is_verified %}
<div class="container mt-5 text-center">
  <h2>You need to be verified before posting a parking spot.</h2>
  <a href="{% url 'verify' %}" class="btn btn-warning">Get Verified to Post a Spot</a>
</div>
{% else %}
  {% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        <li>{{ errors|join:", " }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  <form method="POST" class="w-75 mx-auto" id="create-listing-form">
    {% csrf_token %}
    
    <h4>Spot Details</h4>
    <div class="mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">Spot Title</label>
      {{ form.title|add_class:"form-control" }}
    </div>
    
    <div class="mb-3">
      <label class="form-label">Location (Click on map to select)</label>
      <div class="search-container mb-2">
        <div class="input-group">
          <input type="text" id="location-search" class="form-control" placeholder="Search location..."/>
          <button class="btn btn-primary" id="search-location">Search</button>
        </div>
      </div>
      <div class="map-container" style="height: 400px; width: 100%;">
        <div id="map" style="height: 100%; width: 100%;"></div>
      </div>
      {{ form.location|add_class:"form-control mt-2" }}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.rent_per_hour.id_for_label }}" class="form-label">Price per Hour ($)</label>
      {{ form.rent_per_hour|add_class:"form-control" }}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
      {{ form.description|add_class:"form-control" }}
    </div>
    
    <hr>
    <h4>Availability Slots</h4>
    {{ slot_formset.management_form }}
    <div id="slot-forms-container">
      {% for slot_form in slot_formset %}
        <div class="slot-form border p-3 mb-3">
          <h5>Time Slot {{ forloop.counter }}</h5>
          {{ slot_form.as_p }}
        </div>
      {% endfor %}
    </div>
    <button type="button" class="btn btn-secondary mb-3" id="add-slot-btn">Add Another Slot</button>
    
    <button type="submit" class="btn btn-primary w-100">Post Spot</button>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
        crossorigin=""></script>
<script src="{% static 'listings/js/create_listings.js' %}"></script>
<script>
// (Optional) You can add frontend overlap checking here if desired.
// For now, we rely on backend validation and an alert on form submit.

document.addEventListener("DOMContentLoaded", function() {
  console.log("Create Listing JS loaded.");

  // Simple frontend check for overlapping intervals before submission.
  function checkOverlappingSlots() {
    const forms = document.querySelectorAll(".slot-form");
    const intervals = [];
    for (const formDiv of forms) {
      const startDateVal = formDiv.querySelector("input[name$='start_date']").value;
      const endDateVal = formDiv.querySelector("input[name$='end_date']").value;
      const startTimeVal = formDiv.querySelector("select[name$='start_time']").value;
      const endTimeVal = formDiv.querySelector("select[name$='end_time']").value;
      if (startDateVal && startTimeVal && endDateVal && endTimeVal) {
        const start = new Date(startDateVal + "T" + startTimeVal);
        const end = new Date(endDateVal + "T" + endTimeVal);
        if (start >= end) {
          alert("Each slot's start time must be before its end time.");
          return false;
        }
        // Check overlap with existing intervals.
        for (const interval of intervals) {
          if (!(end <= interval.start || start >= interval.end)) {
            alert("Availability slots cannot overlap.");
            return false;
          }
        }
        intervals.push({ start: start, end: end });
      }
    }
    return true;
  }

  // Attach submit handler to the form.
  document.getElementById("create-listing-form").addEventListener("submit", function(event) {
    if (!checkOverlappingSlots()) {
      event.preventDefault();
    }
  });

  // Dynamic form addition logic.
  const addSlotBtn = document.getElementById("add-slot-btn");
  const slotFormsContainer = document.getElementById("slot-forms-container");
  const totalFormsInput = document.querySelector('[name$="-TOTAL_FORMS"]');
  if (!addSlotBtn || !slotFormsContainer || !totalFormsInput) {
    console.error("Required elements for adding new slot not found.");
    return;
  }
  const formDivs = slotFormsContainer.getElementsByClassName("slot-form");
  if (formDivs.length === 0) {
    console.error("No slot form found to clone.");
    return;
  }
  const blankForm = formDivs[0].cloneNode(true);
  blankForm.querySelectorAll("input, select, textarea").forEach(el => el.value = "");
  const blankHeading = blankForm.querySelector("h5");
  if (blankHeading) blankHeading.textContent = "Time Slot ???";
  
  addSlotBtn.addEventListener("click", function() {
    let formCount = parseInt(totalFormsInput.value);
    let newForm = blankForm.cloneNode(true);
    newForm.querySelectorAll("input, select, textarea, label").forEach(function(el) {
      if (el.name) {
        el.name = el.name.replace(/-\d+-/, `-${formCount}-`);
      }
      if (el.id) {
        el.id = el.id.replace(/_\d+_/, `_${formCount}_`);
      }
    });
    const newHeading = newForm.querySelector("h5");
    if (newHeading) {
      newHeading.textContent = `Time Slot ${formCount + 1}`;
    }
    slotFormsContainer.appendChild(newForm);
    formCount++;
    totalFormsInput.value = formCount.toString();
  });
});
</script>
{% endblock %}
