{% extends 'base.html' %}
{% load widget_tweaks %}
{% load static %}
{% block extra_head %}
<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
{% endblock %}
{% block content %}
<h2 class="text-center">Post A Parking Spot</h2>

{% if not request.user.profile.is_verified %}
<div class="container mt-5 text-center">
  <h2>You need to be verified before posting a parking spot.</h2>
  <a href="{% url 'verify' %}" class="btn btn-warning">Get Verified to Post a Spot</a>
</div>
{% else %}
  {% if form.errors %}
  <div class="alert alert-danger">
    <ul>
      {% for field, errors in form.errors.items %}
        <li>{{ errors|join:", " }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <form method="POST" class="w-75 mx-auto">
    {% csrf_token %}
    
    <h4>Spot Details</h4>
    <div class="mb-3">
      <label for="{{ form.title.id_for_label }}" class="form-label">Spot Title</label>
      {{ form.title|add_class:"form-control" }}
    </div>
    
    <div class="mb-3">
      <label class="form-label">Location (Click on map to select)</label>
      <!-- Search container for the map -->
      <div class="search-container mb-2">
        <div class="input-group">
          <input type="text" id="location-search" class="form-control" placeholder="Search location..." />
          <button class="btn btn-primary" id="search-location">Search</button>
        </div>
      </div>
      <!-- Map container -->
      <div class="map-container" style="height: 400px; width: 100%;">
        <div id="map" style="height: 100%; width: 100%;"></div>
      </div>
      {{ form.location|add_class:"form-control mt-2" }}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.rent_per_hour.id_for_label }}" class="form-label">Price per Hour ($)</label>
      {{ form.rent_per_hour|add_class:"form-control" }}
    </div>
    
    <div class="mb-3">
      <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
      {{ form.description|add_class:"form-control" }}
    </div>
    
    <hr>
    <h4>Availability Slots</h4>
    <!-- Render management form and each slot form -->
    {{ slot_formset.management_form }}
    {% for slot_form in slot_formset %}
      <div class="border p-3 mb-3">
        <h5>Time Slot {{ forloop.counter }}</h5>
        {{ slot_form.as_p }}
      </div>
    {% endfor %}
    
    <button type="submit" class="btn btn-primary w-100">Post Spot</button>
  </form>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>
<script src="{% static 'listings/js/create_listings.js' %}"></script>
{% endblock %}
