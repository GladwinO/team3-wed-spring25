{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="row">
  <!-- LEFT COLUMN: List of users or existing conversations -->
  <div class="col-md-4" style="border-right: 1px solid #ccc; height: 80vh; overflow-y: auto;">
    <h4>Chats</h4>
    <ul class="list-group">
      <!-- Suppose we pass in all users or existing conversations -->
      {% for user in all_users %}
        <!-- 
           On click, we call a JS function loadConversation(user.id) that
           sets up the conversation with that user.
        -->
        <li 
          class="list-group-item" 
          style="cursor: pointer;" 
          onclick="loadConversation('{{ user.id }}')"
        >
          {{ user.username }}
        </li>
      {% endfor %}
    </ul>
  </div>

  <!-- RIGHT COLUMN: Chat messages + input -->
  <div class="col-md-8 d-flex flex-column" style="height: 80vh;">
    <div 
      id="chat-messages" 
      class="flex-grow-1 overflow-auto border p-3" 
      style="margin-bottom: 10px; background-color: #f9f9f9;"
    >
      <!-- Messages will be appended here via JS -->
    </div>
    <div>
      <form onsubmit="sendMessage(event)">
        <div class="input-group">
          <input id="messageInput" type="text" class="form-control" placeholder="Type a message...">
          <button class="btn btn-primary" type="submit">Send</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let chatSocket = null;
  let currentConversationId = null;
  let currentConversationName = null;
  let currentUserId = '{{ request.user.id }}'; // so we know who is sending

  function loadConversation(otherUserId) {
    // In a real app, you'd do an AJAX call to your server to get
    // or create a conversation with (request.user, otherUserId).
    // The server returns a conversation_id and the conversation_name 
    // e.g. "chat_3_5". For demonstration, let's assume we have an endpoint:
    // /messaging/get_or_create_conversation/?other_user_id=XYZ
    fetch(`/messaging/get_or_create_conversation/?other_user_id=${otherUserId}`)
      .then(response => response.json())
      .then(data => {
        currentConversationId = data.conversation_id;
        currentConversationName = data.conversation_name;

        // Close any existing socket
        if (chatSocket) {
          chatSocket.close();
        }

        // Open new WebSocket
        const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
        chatSocket = new WebSocket(
        wsScheme + "://" + window.location.host + "/ws/chat/" + currentConversationName + "/"
        );


        chatSocket.onopen = function(e) {
          console.log("WebSocket connected.");
          // Optionally, load existing messages from the server via AJAX
          loadMessages(currentConversationId);
        };

        chatSocket.onmessage = function(e) {
          const data = JSON.parse(e.data);
          // e.g. { message: 'Hello', sender_id: 3 }
          displayMessage(data.sender_id, data.message);
        };

        chatSocket.onclose = function(e) {
          console.log("WebSocket closed.");
        };
      });
  }

  function loadMessages(conversationId) {
    // Make an AJAX call to get the existing messages for that conversation
    fetch(`/messaging/conversation_messages/${conversationId}/`)
      .then(response => response.json())
      .then(data => {
        const chatMessagesDiv = document.getElementById('chat-messages');
        chatMessagesDiv.innerHTML = ''; // clear existing
        data.messages.forEach(msg => {
          displayMessage(msg.sender_id, msg.content);
        });
      });
  }

  function displayMessage(senderId, messageText) {
    const chatMessagesDiv = document.getElementById('chat-messages');
    const messageEl = document.createElement('div');
    messageEl.classList.add('mb-2');

    if (senderId == currentUserId) {
      messageEl.style.textAlign = 'right';
      messageEl.innerHTML = `<span class="badge bg-primary">${messageText}</span>`;
    } else {
      messageEl.style.textAlign = 'left';
      messageEl.innerHTML = `<span class="badge bg-secondary">${messageText}</span>`;
    }

    chatMessagesDiv.appendChild(messageEl);
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
  }

  function sendMessage(event) {
    event.preventDefault();
    const inputEl = document.getElementById('messageInput');
    const message = inputEl.value.trim();
    if (!message || !chatSocket) return;
    // Send over WebSocket
    chatSocket.send(JSON.stringify({
      'message': message,
      'sender_id': currentUserId,
      'conversation_id': currentConversationId
    }));
    inputEl.value = '';
  }
</script>
{% endblock %}
